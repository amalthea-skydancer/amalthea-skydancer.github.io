<!DOCTYPE html>
<html>
    <head>
        <title>Whip circle</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script type="module">
            // Configuration
            const commandWeights = {
                start: 10,
                left: 35,
                right: 35,
                stop: 20
            };

            const MAX_DELAY_SECONDS = 120; // Maximum delay in seconds (2 minutes)

            const commands = {
                start: ['pre', 'crack', 'post'],
                left: ['pre', 'crack', 'crack', 'crack', 'post'],
                right: ['pre', 'crack', 'crack', 'crack', 'crack', 'post'],
                stop: ['pre', 'crack', 'crack', 'post']
            };

            class AudioPlayer {
                constructor() {
                    this.context = new (window.AudioContext || window.webkitAudioContext)();
                    this.buffers = {};
                    this.loaded = false;
                    this.queue = [];
                    this.isPlaying = false;
                }

                async loadSounds() {
                    if (this.loaded) return;
                    const urls = {
                        'pre': '/wc/pre.wav',
                        'crack': '/wc/crack.wav',
                        'post': '/wc/post.wav'
                    };

                    const fetchPromises = Object.entries(urls).map(async ([name, url]) => {
                        try {
                            const response = await fetch(url);
                            const arrayBuffer = await response.arrayBuffer();
                            this.buffers[name] = await this.context.decodeAudioData(arrayBuffer);
                        } catch (error) {
                            console.error(`Error loading sound ${name}:`, error);
                        }
                    });

                    await Promise.all(fetchPromises);
                    this.loaded = true;
                }

                queueSound(name, delay = 0) {
                    this.queue.push({ name, time: this.context.currentTime + delay });
                    if (!this.isPlaying) {
                        this.playNextInQueue();
                    }
                }

                playNextInQueue() {
                    if (this.queue.length === 0) {
                        this.isPlaying = false;
                        return;
                    }

                    this.isPlaying = true;
                    const { name, time } = this.queue.shift();

                    try {
                        const source = this.context.createBufferSource();
                        source.buffer = this.buffers[name];
                        source.connect(this.context.destination);
                        
                        const startTime = Math.max(time, this.context.currentTime);
                        source.start(startTime);

                        source.onended = () => {
                            this.playNextInQueue();
                        };
                    } catch (error) {
                        console.error(`Error playing sound ${name}:`, error);
                        this.playNextInQueue();
                    }
                }
            }

            const player = new AudioPlayer();
            const preLen = 0.346; // 346ms in seconds
            const crackLen = 0.358; // 358ms in seconds

            // Preload sounds
            await player.loadSounds();

            function queueSequence(sequence) {
                let delay = 0;
                for (const sound of sequence) {
                    player.queueSound(sound, delay);
                    delay += (sound === 'pre' ? preLen : crackLen);
                }
                return delay;
            }

            let isPlaying = false;
            let nextCommandTimeout;
            let commandHistory = [];
            let countdownInterval;

            function getWeightedRandomCommand() {
                const totalWeight = Object.values(commandWeights).reduce((sum, weight) => sum + weight, 0);
                let randomNum = Math.random() * totalWeight;
                
                for (const [command, weight] of Object.entries(commandWeights)) {
                    if (randomNum < weight) return command;
                    randomNum -= weight;
                }
            }

            function getRandomDelay(command) {
                if (command === 'left' || command === 'right') {
                    // Random delay between 1 second and MAX_DELAY_SECONDS
                    return Math.floor(Math.random() * (MAX_DELAY_SECONDS * 1000 - 1000 + 1) + 1000);
                }
                return 1000; // Default 1 second delay for other commands
            }

            function updateCommandHistory(command) {
                commandHistory.unshift(command);
                if (commandHistory.length > 5) {
                    commandHistory.pop();
                }
                const historyElement = document.getElementById('command-history');
                historyElement.innerHTML = commandHistory.map(cmd => `<div>${cmd}</div>`).join('');
            }

            function updateCountdown(remainingTime) {
                const countdownElement = document.getElementById('countdown');
                countdownElement.textContent = (remainingTime / 1000).toFixed(1);
            }

            function startCountdown(duration) {
                let remainingTime = duration;
                updateCountdown(remainingTime);

                clearInterval(countdownInterval);
                countdownInterval = setInterval(() => {
                    remainingTime -= 100; // Update every 100ms for smoother countdown
                    if (remainingTime <= 0) {
                        clearInterval(countdownInterval);
                        remainingTime = 0;
                    }
                    updateCountdown(remainingTime);
                }, 100);
            }

            function playRandomCommand(forceStart = false) {
                if (!isPlaying) return;

                const randomCommand = forceStart ? 'start' : getWeightedRandomCommand();
                const sequence = commands[randomCommand];

                console.log(`Playing: ${randomCommand}`);
                updateCommandHistory(randomCommand);
                const duration = queueSequence(sequence);

                const delay = getRandomDelay(randomCommand);
                console.log(`Next command in ${delay / 1000} seconds`);

                startCountdown(duration * 1000 + delay);

                // Schedule the next command
                nextCommandTimeout = setTimeout(() => playRandomCommand(false), duration * 1000 + delay);
            }

            function startSequence() {
                if (isPlaying) return;
                isPlaying = true;
                commandHistory = [];
                playRandomCommand(true); // Force start command on first play
            }

            function stopSequence() {
                isPlaying = false;
                clearTimeout(nextCommandTimeout);
                clearInterval(countdownInterval);
                updateCountdown(0);
                
                // Play the stop command
                const stopSequence = commands['stop'];
                queueSequence(stopSequence);
                updateCommandHistory('stop');
            }

            document.getElementById("start").addEventListener("click", startSequence);
            document.getElementById("stop").addEventListener("click", stopSequence);
        </script>
        <style>
            body {
                font-family: Arial, sans-serif;
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 20px;
            }
            button {
                font-size: 18px;
                padding: 10px 20px;
                margin: 10px;
            }
            #command-history {
                border: 1px solid #ccc;
                padding: 10px;
                margin-top: 20px;
                width: 200px;
                height: 150px;
                overflow-y: auto;
                display: flex;
                flex-direction: column-reverse;
            }
            #command-history div {
                margin: 5px 0;
                padding: 5px;
                background-color: #f0f0f0;
                border-radius: 3px;
            }
            #countdown-container {
                font-size: 24px;
                margin-top: 20px;
            }
        </style>
    </head>
    <body>
        <button id="start">Start</button>
        <button id="stop">Stop</button>
        <div id="countdown-container">
            Next command in: <span id="countdown">0.0</span> seconds
        </div>
        <div id="command-history"></div>
    </body>
</html>